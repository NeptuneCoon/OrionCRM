@model Orion.CRM.WebApp.Models.Customer.CustomerModel
@{
    ViewData["Title"] = "Add";
    Layout = "~/Views/Shared/_Layout.cshtml";
}



<div class="panel panel-default span10">
    <div class="panel-heading">
        <h3 class="panel-title">新建客户</h3>
    </div>

    <div class="panel-body">
        <form action="/Customer/AddHandler" method="post" class="form-horizontal">
            <div style="background-color:#f5f5f5;padding:10px;width:680px">
                <div style="background-color:#fff;padding:5px">
                    <div class="control-group" style="margin-top:10px">
                        <label class="control-label">客户姓名<span class="required">*</span></label>
                        <div class="controls">
                            <input type="text" style="width:200px" asp-for="RealName" placeholder="客户姓名" reg="regString" is-null="required" maxlength="200" autocomplete="off" />
                            <p class="help-block">请输入客户的真实姓名</p>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">性别</label>
                        <div class="controls" style="padding-top:4px">
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="Sex" value="1" asp-for="Sex">
                                <span class="nebula-radioInput"></span>男
                            </label>
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="Sex" value="2" asp-for="Sex">
                                <span class="nebula-radioInput"></span>女
                            </label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">项目<span class="required">*</span></label>
                        <div class="controls">
                            <select class="m-wrap" style="width:220px" name="ProjectId" placeholder="项目" is-null="required" reg="regNum" onchange="projectChange(this)">
                                <option value="">请选择...</option>
                                @if (ViewBag.Projects != null) {
                                    foreach (var project in ViewBag.Projects) {
                                        if (ViewBag.ProjectId != null && ViewBag.ProjectId == project.Id) {
                                            <option value="@project.Id" selected="selected">@project.ProjectName</option>
                                        }
                                        else {
                                            <option value="@project.Id">@project.ProjectName</option>
                                        }
                                    }
                                }
                            </select>
                            <p class="help-block">请选择用户留言的项目</p>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">手机号码</label>
                        <div class="controls">
                            <input type="text" asp-for="Mobile" style="width:200px" placeholder="手机号码" reg="regMobile" maxlength="11" autocomplete="off" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">身份证号</label>
                        <div class="controls">
                            <input type="text" asp-for="IdentityNo" style="width:200px" placeholder="身份证号" reg="regString" maxlength="18" autocomplete="off" />
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">代理品牌<span class="required">*</span></label>
                        <div class="controls">
                            <select class="m-wrap" style="width:220px" name="BrandId" placeholder="代理品牌" is-null="required" reg="regNum" id="brandSelect">
                                <option value="">请选择...</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">代理级别</label>
                        <div class="controls" style="padding-top:4px">
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="AgentLevel" value="4" onclick="agentLevelChange()" />
                                <span class="nebula-radioInput"></span>直辖市
                            </label>
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="AgentLevel" value="1" onclick="agentLevelChange()" />
                                <span class="nebula-radioInput"></span>省
                            </label>
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="AgentLevel" value="2" onclick="agentLevelChange()" />
                                <span class="nebula-radioInput"></span>市
                            </label>
                            <label class="nebula-label">
                                <input class="nebula-radio" type="radio" name="AgentLevel" value="3" onclick="agentLevelChange()" />
                                <span class="nebula-radioInput"></span>县/区
                            </label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">代理区域</label>
                        <div class="controls">
                            <select class="m-wrap" style="width:120px" name="AgentZone1" id="provinceSelect" onchange="provinceChange()">
                                <option value="">请选择...</option>
                            </select>
                            <select class="m-wrap" style="width:180px" name="AgentZone2" id="citySelect" onchange="cityChange()">
                                <option value="">请选择...</option>
                            </select>
                            <select class="m-wrap" style="width:180px" name="AgentZone3" id="districtSelect">
                                <option value="">请选择...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions" style="padding-left:140px">
                        <button type="submit" class="btn btn-primary" id="btnSubmit" onclick="return checkForm()">保&nbsp;&nbsp;存</button>
                        <a href="/Customer/All" class="btn">返回</a>
                    </div>
                </div>
            </div>

        </form>
    </div>
</div>


@section scripts{
    <script src="~/assets/province.js"></script>
    <script type="text/javascript">
        function projectChange(e) {
            var projectId = $(e).find("option:selected").val();
            $("#brandSelect option").not(":first").remove();
            $.get("/Brand/GetBrandsByProjectId", { "projectId": projectId }, function (data) {
                if (data) {
                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var option = '<option value="' + item.id + '">' + item.brandName + '</option>';
                        $('#brandSelect').append(option);
                    }
                }
            });
        }

        function agentLevelChange() {
            $('#citySelect,#districtSelect').show();
            var agentLevel = $('input[name="AgentLevel"]:checked').val();
            if (agentLevel == "1") {
                // 省
                zoneInit.renderProvince('provinceSelect');

                $('#citySelect').find('option').not(":first").remove();//清空市下拉框
                $('#districtSelect').find('option').not(":first").remove();//清空县/区下拉框
                $('#citySelect,#districtSelect').hide();
            }
            else if (agentLevel == "2") {
                // 市
                zoneInit.renderProvince('provinceSelect');
                $('#citySelect').find('option').not(":first").remove();//清空市下拉框
                $('#districtSelect').find('option').not(":first").remove();//清空县/区下拉框
                $('#districtSelect').hide();
            }
            else if (agentLevel == "3") {
                // 县/区
                $('#citySelect').find('option').not(":first").remove();//清空市下拉框
                $('#districtSelect').find('option').not(":first").remove();//清空县/区下拉框
                zoneInit.renderProvince('provinceSelect', true);
            }
            else if (agentLevel == "4") {
                // 直辖市
                zoneInit.renderMunicipality('provinceSelect');
                
                $('#citySelect').find('option').not(":first").remove();//清空市下拉框
                $('#districtSelect').find('option').not(":first").remove();//清空县/区下拉框
                $('#citySelect,#districtSelect').hide();
            }
        }

        function provinceChange() {
            var agentLevel = $('input[name="AgentLevel"]:checked').val();
            if (agentLevel == "4") return; //代理级别是直辖市，直接return

            $('#citySelect,#districtSelect').show();
            if (agentLevel == "1") {
                $('#citySelect,#districtSelect').hide();  
            }
            else if (agentLevel == "2") {
                // 生成市级下拉框
                var province = $('#provinceSelect').find("option:selected").val();
                console.info(province);
                zoneInit.renderCity(province, 'citySelect');
                // 隐藏县/区下拉框
                $('#districtSelect').hide();  
            }
            else {
                // 首先生成市级下拉框
                var province = $('#provinceSelect').find("option:selected").val();
                zoneInit.renderCity(province, 'citySelect');

                // 然后判断是否隐藏第3个区域框
                var arr = ['北京', '上海', '天津', '重庆'];
                var province = $('#provinceSelect').find("option:selected").val();
                if (agentLevel == "3" && arr.indexOf(province) >= 0) { //县/区代理级别，且城市选的直辖市，隐藏第3个区域下拉框
                    $('#districtSelect').hide();
                }
                else {
                    $('#citySelect,#districtSelect').show();
                }
            }


        }
        function cityChange() {
            $('#citySelect,#districtSelect').show();

            var province = $('#provinceSelect').find("option:selected").val();
            var city = $('#citySelect').find("option:selected").val();
            zoneInit.renderDistrict(province, city, 'districtSelect');

            var agentLevel = $('input[name="AgentLevel"]:checked').val();
            if (agentLevel == "1") {
                $('#provinceSelect').show();
                $('#citySelect,#districtSelect').hide();  
            }
            else if (agentLevel == "2") {
                $('#citySelect').show();
                $('#districtSelect').hide();  
            }
            if (agentLevel == "3") {
                var arr = ['北京', '上海', '天津', '重庆'];
                var province = $('#provinceSelect').find("option:selected").val();
                if (agentLevel == "3" && arr.indexOf(province) >= 0) { //县/区代理级别，且城市选的直辖市，隐藏第3个区域下拉框
                    $('#districtSelect').hide();
                }
                else {
                    $('#citySelect,#districtSelect').show();
                }
            }
            else if (agentLevel == "4") {
                $('#citySelect,#districtSelect').hide();  
            }
        }

        function checkForm() {
            var result = true;

            try {
                $('form').find("input,select").each(function () {
                    var res = inputCheck($(this));
                    if (!res) {
                        result = res;
                    }
                });
                return result;
            }
            catch (ex) {
                result = false;
                console.info('表单验证过程中发现异常：' + ex);
            }
        }

        $(document).ready(function () {
            zoneInit.renderProvince('provinceSelect');
        });
    </script>
}




